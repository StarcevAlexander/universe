<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .section {
            background: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        button, input[type="file"] {
            padding: 10px 16px;
            font-size: 16px;
            margin: 5px 0;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            color: #007bff;
        }

        .video-list {
            margin-top: 15px;
        }

        .video-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-info {
            flex-grow: 1;
        }

        .video-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .video-meta {
            font-size: 14px;
            color: #6c757d;
        }

        .video-actions {
            display: flex;
            gap: 10px;
        }

        .video-actions button {
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-view {
            background: #28a745;
        }

        .btn-delete {
            background: #dc3545;
        }

        .btn-view:hover {
            background: #218838;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .video-player {
            max-width: 100%;
            max-height: 400px;
            margin: 10px 0;
        }

        .no-videos {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
<h1>–≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>

<!-- –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ email -->
<div class="section">
    <h2>üìß –û—Ç–ø—Ä–∞–≤–∫–∞ CSV –ø–æ –ø–æ—á—Ç–µ</h2>
    <p>–û—Ç–ø—Ä–∞–≤–∏—Ç—å CSV —Ñ–∞–π–ª —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –Ω–∞ –ø–æ—á—Ç—É 79140050089@yandex.ru</p>
    <button onclick="sendCSVByEmail()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ –ø–æ—á—Ç–µ</button>
    <div id="emailMessage"></div>
</div>
<!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
<div class="section">

    <h2>üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã</h2>
    <button onclick="loadData()">–û–±–Ω–æ–≤–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    <div id="dataContainer">
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
    </div>
</div>

<!-- –≠–∫—Å–ø–æ—Ä—Ç -->
<div class="section">
    <h2>üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV</h2>
    <p>–°–∫–∞—á–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV (UTF-8 —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º <code>;</code>).</p>
    <button onclick="exportCSV()">–°–∫–∞—á–∞—Ç—å CSV</button>
</div>

<!-- –ò–º–ø–æ—Ä—Ç -->
<div class="section">
    <h2>üì§ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV</h2>
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV-—Ñ–∞–π–ª. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–ª–∏—Ü—ã <code>users</code> –±—É–¥–µ—Ç <strong>–ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–µ–Ω–æ</strong>.</p>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="csvFile" name="file" accept=".csv" required/>
        <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∑–∞–º–µ–Ω–∏—Ç—å</button>
    </form>
    <div id="uploadMessage"></div>
</div>

<!-- –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ -->
<div class="section">
    <h2>üé• –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</h2>
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª—ã (–º–∞–∫—Å. 100MB). –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, WMV, FLV, WebM, MKV</p>

    <form id="uploadVideoForm" enctype="multipart/form-data">
        <input type="file" id="videoFile" name="video" accept="video/*" required/>
        <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
    </form>
    <div id="videoUploadMessage"></div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ -->
<div class="section">
    <h2>üìπ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ</h2>
    <button onclick="loadVideos()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ</button>
    <div id="videosContainer">
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ.</p>
    </div>
</div>

<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ /users –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
    async function loadData() {
        const container = document.getElementById('dataContainer');
        container.innerHTML = '<p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

        try {
            const res = await fetch('/users');
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            const users = await res.json();

            if (users.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ.</p>';
                return;
            }

            let html = `<table><thead><tr><th>ID</th><th>–ò–º—è</th></tr></thead><tbody>`;
            users.forEach(u => {
                html += `<tr><td>${u.id}</td><td>${u.name}</td></tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        } catch (err) {
            container.innerHTML = `<p class="error">‚ùå ${err.message}</p>`;
        }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç
    function exportCSV() {
        const link = document.createElement('a');
        link.href = '/export-csv';
        link.download = 'users.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // –ò–º–ø–æ—Ä—Ç
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('csvFile');
        const msg = document.getElementById('uploadMessage');
        const file = fileInput.files[0];

        if (!file) {
            msg.className = 'message error';
            msg.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        msg.className = 'message loading';
        msg.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

        try {
            const res = await fetch('/upload-csv', {method: 'POST', body: formData});
            const result = await res.json();

            if (res.ok) {
                msg.className = 'message success';
                msg.textContent = `‚úÖ –£—Å–ø–µ—Ö! –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç—Ä–æ–∫: ${result.rows || 0}`;
                fileInput.value = '';
                loadData(); // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
            } else {
                msg.className = 'message error';
                msg.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
            }
        } catch (err) {
            msg.className = 'message error';
            msg.textContent = `‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${err.message}`;
        }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ CSV –ø–æ email
    async function sendCSVByEmail() {
        const msg = document.getElementById('emailMessage');
        msg.className = 'message loading';
        msg.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

        try {
            const res = await fetch('/send-csv-email', {
                method: 'POST'
            });
            const result = await res.json();

            if (res.ok) {
                msg.className = 'message success';
                msg.textContent = '‚úÖ CSV —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ—á—Ç—É';
            } else {
                msg.className = 'message error';
                msg.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
            }
        } catch (err) {
            msg.className = 'message error';
            msg.textContent = `‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${err.message}`;
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
    document.getElementById('uploadVideoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('videoFile');
        const msg = document.getElementById('videoUploadMessage');
        const file = fileInput.files[0];

        if (!file) {
            msg.className = 'message error';
            msg.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª';
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (100MB)
        if (file.size > 100 * 1024 * 1024) {
            msg.className = 'message error';
            msg.textContent = '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 100MB)';
            return;
        }

        const formData = new FormData();
        formData.append('video', file);

        msg.className = 'message loading';
        msg.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...';

        try {
            const res = await fetch('/upload-video', {
                method: 'POST',
                body: formData
            });
            const result = await res.json();

            if (res.ok) {
                msg.className = 'message success';
                msg.textContent = `‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${result.filename}`;
                fileInput.value = '';
                loadVideos(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ
            } else {
                msg.className = 'message error';
                msg.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
            }
        } catch (err) {
            msg.className = 'message error';
            msg.textContent = `‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${err.message}`;
        }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–∏–¥–µ–æ
    async function loadVideos() {
        const container = document.getElementById('videosContainer');
        container.innerHTML = '<p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–∏–¥–µ–æ...</p>';

        try {
            const res = await fetch('/videos');
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≤–∏–¥–µ–æ');
            const videos = await res.json();

            if (videos.length === 0) {
                container.innerHTML = '<p class="no-videos">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ</p>';
                return;
            }

            let html = '<div class="video-list">';
            videos.forEach(video => {
                const sizeMB = (video.size / (1024 * 1024)).toFixed(2);
                html += `
                <div class="video-item">
                    <div class="video-info">
                        <div class="video-name">${video.filename}</div>
                        <div class="video-meta">
                            –†–∞–∑–º–µ—Ä: ${sizeMB} MB |
                            –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${video.uploaded_at}
                        </div>
                    </div>
                    <div class="video-actions">
                        <button class="btn-view" onclick="viewVideo('${video.filename}')">
                            üëÅÔ∏è –°–º–æ—Ç—Ä–µ—Ç—å
                        </button>
                        <button class="btn-delete" onclick="deleteVideo('${video.filename}')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `;
            });
            html += '</div>';
            container.innerHTML = html;
        } catch (err) {
            container.innerHTML = `<p class="error">‚ùå ${err.message}</p>`;
        }
    }

    // –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ
    function viewVideo(filename) {
        const videoUrl = `/video/${filename}`;

        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';

        modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>${filename}</h3>
                <button onclick="this.closest('div').parentElement.remove()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                    ‚úï
                </button>
            </div>
            <video controls class="video-player">
                <source src="${videoUrl}" type="video/mp4">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
            </video>
        </div>
    `;

        document.body.appendChild(modal);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –≤–∏–¥–µ–æ
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ
    async function deleteVideo(filename) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ "${filename}"?`)) {
            return;
        }

        try {
            const res = await fetch(`/delete-video/${filename}`, {
                method: 'DELETE'
            });
            const result = await res.json();

            if (res.ok) {
                alert('‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ');
                loadVideos(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (err) {
            alert(`‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${err.message}`);
        }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        loadVideos();
    });
</script>
</body>
</html>